{% extends 'base.html' %} {# Inherits the global layout: header, footer, etc. #}

{% block content %}
<!-- Blog Post Detail Page -->
<div class="container my-5">
    <div class="row">
        <div class="col-lg-8 mx-auto"> {# Centers the post and limits width on large screens #}
            <article>
                <!-- Blog Post Title -->
                <h1>{{ post.title }}</h1>
                <!-- Featured Image -->
                <img src="{{ post.featured_image.url }}" class="img-fluid mb-4" alt="{{ post.title }}">
                <!-- Metadata: date, author, and status -->
                <div class="mb-4 text-muted">
                    Posted on {{ post.created_at|date:"F j, Y" }} by {{ post.author.email|default:"Unknown" }}
                    <div class="mb-3">
                        <!-- Reaction Buttons -->
                        <div class="d-flex align-items-center gap-4 mt-3 mb-4">
                          <!-- Like Button -->
                          <div class="position-relative text-center">
                            <!-- Custom data attribute indicating this is a 'like' button -->
                            <!-- Custom data attribute with the current post ID -->
                            <!-- Set button size -->
                            <button type="button"
                                    class="reaction-btn btn btn-outline-success rounded-circle shadow like-btn"
                                    data-action="like"
                                    data-post="{{ post.id }}"
                                    style="width: 48px; height: 48px;">
                              <!-- Icon inside the button -->
                              <i class="fas fa-leaf"></i>
                            </button>
                            <!-- Like count badge -->
                            <span class="badge bg-success position-absolute top-0 start-100 translate-middle rounded-pill" id="like-count">
                                <!-- Displays total like count from backend -->
                                {{ like_count }}
                            </span>
                            <!-- Text label under the button -->
                            <small class="d-block mt-1 text-success">Like</small>
                          </div>

                          <!-- Dislike Button -->
                          <div class="position-relative text-center">
                            <!-- Indicates this is a 'dislike' button -->
                            <!-- Current post ID -->
                            <!-- Set button size -->
                            <button type="button"
                                    class="reaction-btn btn btn-outline-danger rounded-circle shadow dislike-btn"
                                    data-action="dislike"
                                    data-post="{{ post.id }}"
                                    style="width: 48px; height: 48px;">
                              <!-- Icon for dislike -->
                              <i class="fas fa-bug"></i>
                            </button>
                            <!-- Dislike count badge -->
                            <span class="badge bg-danger position-absolute top-0 start-100 translate-middle rounded-pill" id="dislike-count">
                                <!-- Displays total dislike count -->
                                {{ dislike_count }}
                            </span>
                            <!-- Text label under the button -->
                            <small class="d-block mt-1 text-danger">Dislike</small>
                          </div>
                        </div>
                        <!-- Section showing users who liked the post -->
                        <div class="mt-4">
                          <h6 class="text-muted">Liked by:</h6>
                          <div class="d-flex flex-wrap gap-2">
                            <!-- Loop through all reactions for this post -->
                            {% for r in post.reactions.all %}
                              {% if r.action == 'like' %}
                                <!-- Display badge with user email for each like -->
                                <span class="badge bg-light border text-success">{{ r.user.email }}</span>
                              {% endif %}
                            {% endfor %}
                          </div>
                        </div>
                    </div>
                    {% if not post.published %}<span class="badge bg-warning ms-2">Pending Approval</span>{% endif %}
                </div>
                <!-- Blog Content -->
                <div class="content">
                    {{ post.content|linebreaks }}
                    {# Converts line breaks into HTML paragraphs and <br> tags #}
                </div>
            </article>

            <!-- Post Actions (Edit Button) -->
            {% if can_edit_all %}
              <div class="d-flex justify-content-end mb-3">
                  <a href="{% url 'blog:post_update' post.slug %}" class="btn btn-outline-primary">
                      <i class="fas fa-edit"></i> Edit Post
                  </a>
              </div>
            {% endif %}

            <!-- Comments Section -->
            <div class="mt-5">
              <h3 class="mb-4">Comments</h3>

              {% for comment in comments %}
                <!-- Each comment card -->
                <div class="card mb-3 shadow-sm" id="comment-{{ comment.id }}">
                  <div class="card-body d-flex justify-content-between align-items-start">
                    <!-- Left side: Avatar and user info -->
                    <div class="d-flex">
                      {% if comment.author.profile_picture %}
                          <!-- User has a profile picture -->
                          <img src="{{ comment.author.profile_picture.url }}"
                               class="rounded-circle me-3"
                               style="width: 50px; height: 50px; object-fit: cover;" alt="Avatar">
                        {% else %}
                          <!-- Default avatar if no profile picture -->
                          <img src="https://thumbs.dreamstime.com/b/no-user-profile-picture-hand-drawn-illustration-53840970.jpg"
                               class="rounded-circle me-3"
                               style="width: 50px; height: 50px; object-fit: cover;" alt="Avatar">
                        {% endif %}
                      <!-- Comment text and author details -->
                      <div>
                        <h6 class="mb-0 d-flex align-items-center gap-2">
                          {% if comment.author.get_full_name %}
                            {{ comment.author.get_full_name }}
                          {% else %}
                            Anonymous
                          {% endif %}
                          <!-- Admin or Moderator badge -->
                          {% if comment.author.is_superuser %}
                            <span class="badge bg-danger text-white"><i class="fas fa-shield-alt me-1"></i>Admin</span>
                          {% elif comment.author.is_staff %}
                            <span class="badge bg-info text-dark"><i class="fas fa-user-shield me-1"></i>Moderator</span>
                          {% endif %}
                        </h6>
                        <!-- Author's email -->
                        <small class="text-muted d-block">{{ comment.author.email }}</small>
                        <!-- Comment text -->
                        <p class="mt-2 mb-1">{{ comment.text }}</p>
                        <!-- Timestamp and (edited) tag -->
                        <small class="text-muted">
                          {{ comment.created_at|date:"F j, Y, H:i" }}
                          {% if comment.updated_at|date:"U" > comment.created_at|date:"U" %}
                            <span class="ms-2 text-muted fst-italic">(edited)</span>
                          {% endif %}
                        </small>
                      </div>
                    </div>

                    <!-- Right side: Edit/Delete buttons -->
                    {% if user == comment.author or user.is_staff or user.is_superuser %}
                      <div class="mt-2 d-flex gap-2">
                        <!-- Edit button -->
                        <button class="btn btn-sm btn-outline-warning" onclick="toggleEditForm({{ comment.id }})">Edit</button>
                        <!-- Delete button (only staff or superuser) -->
                        {% if user.is_staff or user.is_superuser %}
                          <form method="post" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="comment_id" value="{{ comment.id }}">
                            <button type="submit" name="submit_delete" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Are you sure you want to delete this comment?');">Delete</button>
                          </form>
                        {% endif %}
                      </div>
                      <!-- Inline edit form -->
                      <form method="post" class="mt-2 d-none" id="edit-form-{{ comment.id }}">
                        {% csrf_token %}
                        <input type="hidden" name="comment_id" value="{{ comment.id }}">
                        <textarea name="text" rows="3" class="form-control">{{ comment.text }}</textarea>
                        <button type="submit" name="submit_edit" class="btn btn-sm btn-success mt-1">Save</button>
                        <button type="button" class="btn btn-sm btn-secondary mt-1" onclick="toggleEditForm({{ comment.id }})">Cancel</button>
                      </form>
                    {% endif %}
                  </div>
                </div>
              {% empty %}
                <!-- If there are no comments -->
                <p class="text-muted">No comments yet.</p>
              {% endfor %}

              <!-- New comment form -->
              {% if user.is_authenticated %}
                <div class="card mt-4 shadow-sm">
                  <div class="card-body d-flex">
                    {% if user.profile_picture %}
                      <img src="{{ user.profile_picture.url }}"
                           class="rounded-circle me-3"
                           style="width: 50px; height: 50px; object-fit: cover;" alt="Avatar">
                    {% else %}
                      <img src="https://thumbs.dreamstime.com/b/no-user-profile-picture-hand-drawn-illustration-53840970.jpg"
                           class="rounded-circle me-3"
                           style="width: 50px; height: 50px; object-fit: cover;" alt="Avatar">
                    {% endif %}
                    <!-- Form to post a new comment -->
                    <form method="post" class="flex-grow-1">
                      {% csrf_token %}
                      <div class="mb-2">
                        {{ comment_form.text }}
                      </div>
                      <button type="submit" name="submit_comment" class="btn btn-success">Post Comment</button>
                    </form>
                  </div>
                </div>
              {% else %}
                <!-- Prompt to log in -->
                {% if user.is_authenticated %}
                  <!-- show comment form -->
                {% else %}
                  <p class="mt-4">
                    Please, <a href="/accounts/login/?next={{ request.path }}">log in</a> to post a comment.
                  </p>
                {% endif %}
              {% endif %}
            </div>
            <!-- JS function to toggle visibility of edit form -->
            <script>
            function toggleEditForm(id) {
              const form = document.getElementById(`edit-form-${id}`);
              form.classList.toggle('d-none');
            }
            </script>
        </div>
    </div>
</div>

<!-- This script handles like and dislike button interactions on blog posts.
     It allows users to react (like/dislike) to a post via AJAX, updates the like/dislike counters,
     and highlights the selected button without reloading the page. -->
<script>
// Wait until the page is fully loaded
document.addEventListener("DOMContentLoaded", function () {
    // Get CSRF token from meta tag for secure POST requests
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Attach click listeners to all like/dislike buttons
    document.querySelectorAll('.reaction-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            // Get post ID and reaction type (like/dislike) from data attributes
            const postId = this.dataset.post;
            const action = this.dataset.action;

            // Send the reaction to the backend via AJAX
            fetch("{% url 'blog:post_react' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken, // Required for Django to accept the request
                },
                body: JSON.stringify({ post_id: postId, action: action }),
            })
            .then(response => response.json())
            .then(data => {
                // If the server responded successfully, update the UI
                // If the response indicates success:
                // Updates the like and dislike counters in the DOM.
                // Removes the active class from all buttons.
                // Adds the active class to the clicked button (either like or dislike).
                if (data.success) {
                    // Update like/dislike counters in the DOM
                    document.getElementById('like-count').textContent = data.likes;
                    document.getElementById('dislike-count').textContent = data.dislikes;

                    // Remove 'active' class from all buttons
                    document.querySelectorAll('.reaction-btn').forEach(btn => btn.classList.remove('active'));
                    // Add 'active' class to the selected button
                    if (action === 'like') {
                        document.querySelector('.like-btn').classList.add('active');
                    } else {
                        document.querySelector('.dislike-btn').classList.add('active');
                    }
                }
            });
        });
    });
});
</script>
{% endblock %}